<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">مزيل الخلفية الاحترافي AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            text: '#e5e5e5'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
        env.allowLocalModels = false;
        window.generateAltText = async (file, id) => {
            const statusEl = document.getElementById(`status-${id}`);
            const resultEl = document.getElementById(`alt-${id}`);
            const btn = document.getElementById(`btn-alt-${id}`);
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const captioner = await pipeline('image-to-text', 'Xenova/vit-gpt2-image-captioning');
                    const output = await captioner(e.target.result);
                    const caption = output[0].generated_text;
                    
                    resultEl.textContent = caption;
                    resultEl.classList.remove('hidden');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                    
                    // Copy to clipboard option
                    resultEl.onclick = () => {
                        navigator.clipboard.writeText(caption);
                        alert('تم نسخ الوصف!');
                    };
                };
                reader.readAsDataURL(file);
                
            } catch (err) {
                console.error(err);
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                btn.disabled = false;
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            touch-action: manipulation; /* Improves touch response */
        }
        body {
            font-family: 'Tajawal', sans-serif;
        }
        .upload-area.drag-over {
            background-color: #e0f2fe;
            border-color: #0ea5e9;
        }
        .dark .upload-area.drag-over {
            background-color: #1e3a8a;
            border-color: #3b82f6;
        }
        /* Transparency Checkerboard Pattern */
        .transparent-bg {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                              linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .dark .transparent-bg {
            background-image: linear-gradient(45deg, #374151 25%, transparent 25%), 
                              linear-gradient(-45deg, #374151 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #374151 75%), 
                              linear-gradient(-45deg, transparent 75%, #374151 75%);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d2d2d; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col transition-colors duration-300 overflow-x-hidden">

    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-colors duration-300 w-full">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                    <div class="bg-blue-600 text-white p-1.5 sm:p-2 rounded-lg flex-shrink-0">
                        <i class="fa-solid fa-wand-magic-sparkles text-lg sm:text-xl"></i>
                    </div>
                    <h1 class="text-base sm:text-2xl font-bold text-gray-900 dark:text-white truncate" data-i18n="appTitle">AI Background Remover</h1>
                </div>
                
                <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0 ml-2">
                    <div class="text-sm text-gray-500 dark:text-gray-400 hidden md:block">
                        <span class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 text-xs font-semibold px-2.5 py-0.5 rounded border border-green-400 dark:border-green-700 mx-2" data-i18n="modelBadge">IS-Net Ultra HD</span>
                        <span data-i18n="features">دقة عالية (5500×5500) • إزالة تلقائية</span>
                    </div>

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors" title="Toggle Theme">
                        <i class="fa-solid fa-moon dark:hidden text-lg"></i>
                        <i class="fa-solid fa-sun hidden dark:block text-lg"></i>
                    </button>

                    <!-- Language Toggle -->
                    <button onclick="toggleLanguage()" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold transition-colors" title="Switch Language">
                        <span id="lang-text">EN</span>
                    </button>
                    
                    <!-- Share Button -->
                    <button onclick="toggleShareModal()" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 font-medium transition-colors mx-2 flex items-center gap-1" title="Share Image">
                        <i class="fa-solid fa-share-nodes text-lg"></i>
                        <span class="hidden sm:inline" data-i18n="shareLink">مشاركة الصور</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="toggleShareModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-cloud-arrow-up text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title" data-i18n="shareTitle">
                                مشاركة رابط الصورة
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-i18n="shareDesc">
                                    ارفع صورة للحصول على رابط مباشر للمشاركة. لا يوجد حد للحجم.
                                </p>
                                
                                <!-- Drop Zone -->
                                <div id="share-drop-zone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
                                    <input type="file" id="share-file-input" class="hidden">
                                    <i class="fa-solid fa-image text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="shareDrop">اضغط أو اسحب الصورة هنا</p>
                                </div>

                                <!-- Progress -->
                                <div id="share-progress" class="hidden mt-4">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                        <div id="share-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs text-center mt-1 text-gray-500" data-i18n="uploading">جاري الرفع...</p>
                                </div>

                                <!-- Result -->
                                <div id="share-result" class="hidden mt-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex items-center gap-2">
                                    <input type="text" id="share-link-input" class="flex-1 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded px-2 py-1 text-sm text-gray-800 dark:text-white" readonly>
                                    <button onclick="copyShareLink()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
                                        <i class="fa-solid fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="toggleShareModal()" data-i18n="close">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full">
        
        <!-- Hero Section -->
        <div class="text-center mb-8 md:mb-12 px-2">
            <h2 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 dark:text-white tracking-tight break-words">
                <span data-i18n="heroTitleStart">إزالة الخلفية</span> 
                <span class="text-blue-600 inline-block" data-i18n="heroTitleHighlight">بذكاء ودقة</span>
            </h2>
            <p class="mt-4 md:mt-5 max-w-xl mx-auto text-lg md:text-xl text-gray-500 dark:text-gray-400 px-4" data-i18n="heroSubtitle">
                ارفع صورك وسيقوم الذكاء الاصطناعي بإزالة الخلفية وتغيير الحجم تلقائياً إلى 5500×5500 بكسل.
            </p>
        </div>

        <!-- Options -->
        <div class="max-w-3xl mx-auto mb-6 flex flex-wrap justify-center items-center gap-4 px-4">
            <label class="inline-flex items-center cursor-pointer group">
                <input type="checkbox" id="auto-download" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 flex-shrink-0"></div>
                <span class="ms-3 text-sm font-medium text-gray-700 dark:text-gray-300 break-words max-w-[200px] sm:max-w-none" data-i18n="autoDownload">تحميل تلقائي بعد المعالجة</span>
            </label>

            <label class="inline-flex items-center cursor-pointer group">
                <input type="checkbox" id="remove-bg-check" class="sr-only peer" checked>
                <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 dark:peer-focus:ring-red-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600 flex-shrink-0"></div>
                <span class="ms-3 text-sm font-medium text-gray-700 dark:text-gray-300 break-words max-w-[200px] sm:max-w-none" data-i18n="removeBgOption">إزالة الخلفية</span>
            </label>

            <label class="inline-flex items-center cursor-pointer group">
                <input type="checkbox" id="upscale-check" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600 flex-shrink-0"></div>
                <span class="ms-3 text-sm font-medium text-gray-700 dark:text-gray-300 break-words max-w-[200px] sm:max-w-none" data-i18n="upscaleOption">تكبير الصورة (5500x5500)</span>
            </label>

            <label class="inline-flex items-center cursor-pointer group">
                <input type="checkbox" id="enhance-check" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600 flex-shrink-0"></div>
                <span class="ms-3 text-sm font-medium text-gray-700 dark:text-gray-300 break-words max-w-[200px] sm:max-w-none" data-i18n="enhanceOption">تحسين الجودة (AI Enhance)</span>
            </label>
        </div>

        <!-- Upload Area -->
        <div class="max-w-3xl mx-auto px-4 sm:px-0">
            <div id="upload-area" class="upload-area border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-6 sm:p-12 text-center bg-white dark:bg-gray-800 hover:border-blue-500 dark:hover:border-blue-500 transition-colors duration-300 cursor-pointer shadow-sm group touch-manipulation">
                <input type="file" id="file-input" class="hidden" multiple accept="image/*">
                
                <div class="mb-4">
                    <div class="mx-auto w-16 h-16 sm:w-20 sm:h-20 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl sm:text-4xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                </div>
                
                <h3 class="text-lg sm:text-xl font-medium text-gray-900 dark:text-white mb-2" data-i18n="dropText">اضغط هنا أو اسحب الصور للإفلات</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm" data-i18n="supportedFormats">يدعم JPG, PNG, WEBP (صور متعددة)</p>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="max-w-3xl mx-auto mt-8 hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-blue-700 dark:text-blue-400" data-i18n="processing">جاري المعالجة...</span>
                <span class="text-sm font-medium text-blue-700 dark:text-blue-400"><span id="completed-count">0</span> / <span id="total-count">0</span></span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="actions-section" class="max-w-3xl mx-auto mt-8 hidden text-center">
            <button onclick="downloadAllAsZip()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all transform hover:scale-105">
                <i class="fa-solid fa-file-zipper mx-2"></i>
                <span data-i18n="downloadAll">تحميل الكل (ZIP)</span>
            </button>
            <button onclick="clearAll()" class="inline-flex items-center px-6 py-3 border border-gray-300 dark:border-gray-600 text-base font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mx-4 transition-all">
                <i class="fa-solid fa-trash mx-2"></i>
                <span data-i18n="clearAll">مسح الكل</span>
            </button>
        </div>

        <!-- Results Grid -->
        <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-12">
            <!-- Items will be injected here -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 mt-auto transition-colors duration-300">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 dark:text-gray-400 text-sm" data-i18n="copyright">
                &copy; 2026 AI Background Remover. جميع الحقوق محفوظة.
            </p>
        </div>
    </footer>

    <!-- Template for Result Item -->
    <template id="result-item-template">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 border border-gray-100 dark:border-gray-700 flex flex-col h-full">
            <div class="relative h-64 bg-gray-100 dark:bg-gray-700 group">
                <!-- Original Image (Background) -->
                <div class="absolute inset-0 flex items-center justify-center p-4">
                     <img class="max-h-full max-w-full object-contain opacity-50 filter grayscale" src="" alt="Original">
                </div>
                
                <!-- Processed Image (Foreground) -->
                <div class="absolute inset-0 flex items-center justify-center p-4 transparent-bg">
                    <img class="processed-img max-h-full max-w-full object-contain transition-transform duration-300 group-hover:scale-105" src="" alt="Processed">
                </div>

                <!-- Status Overlay -->
                <div class="status-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white hidden">
                    <div class="text-center">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i>
                        <p data-i18n="processing">جاري المعالجة...</p>
                    </div>
                </div>
                
                <!-- Badge -->
                <span class="absolute top-2 right-2 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-400 dark:border-blue-700">
                    5500x5500
                </span>
            </div>
            
            <div class="p-4 flex flex-col flex-grow">
                <!-- File Name & Edit -->
                <div class="flex items-center justify-between mb-1 group/edit">
                    <h4 class="text-lg font-bold text-gray-900 dark:text-white truncate flex-1 file-name cursor-pointer" title="">اسم الملف</h4>
                    <input type="text" class="name-input hidden flex-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1" value="">
                    <button class="edit-btn text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 ml-2 p-1 rounded transition-colors opacity-0 group-hover/edit:opacity-100 focus:opacity-100" title="Edit Name">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>

                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4 file-size">-- KB</p>
                
                <div class="mt-auto flex flex-col gap-2">
                    <!-- Alt Text Section -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">Alt Text (AI)</span>
                            <button class="btn-alt text-xs bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300 px-2 py-1 rounded hover:bg-purple-200 transition-colors">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> توليد
                            </button>
                        </div>
                        <p class="alt-text text-xs text-gray-700 dark:text-gray-300 italic hidden cursor-pointer hover:text-blue-500" title="اضغط للنسخ"></p>
                        <p class="alt-status text-xs text-gray-400 hidden">جاري التحليل...</p>
                    </div>

                    <div class="flex gap-2 flex-wrap">
                        <button class="download-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed min-w-[100px]">
                            <i class="fa-solid fa-download"></i> <span class="btn-text">تحميل</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- Translations ---
        const translations = {
            ar: {
                pageTitle: "مزيل الخلفية الاحترافي AI",
                appTitle: "AI Background Remover",
                modelBadge: "IS-Net Ultra HD",
                features: "دقة عالية (5500×5500) • إزالة تلقائية",
                heroTitleStart: "إزالة الخلفية",
                heroTitleHighlight: "بذكاء ودقة",
                heroSubtitle: "ارفع صورك وسيقوم الذكاء الاصطناعي بإزالة الخلفية وتغيير الحجم تلقائياً إلى 5500×5500 بكسل.",
                autoDownload: "تحميل تلقائي بعد المعالجة",
                upscaleOption: "تكبير الصورة (5500x5500)",
                enhanceOption: "تحسين الجودة (AI Enhance)",
                removeBgOption: "إزالة الخلفية",
                dropText: "اضغط هنا أو اسحب وأفلت الصور",
                supportedFormats: "يدعم JPG, PNG, WEBP (صور متعددة)",
                processing: "جاري المعالجة...",
                downloadAll: "تحميل الكل (ZIP)",
                clearAll: "مسح الكل",
                copyright: "© 2026 AI Background Remover. جميع الحقوق محفوظة.",
                download: "تحميل",
                shareLink: "مشاركة الصور",
                shareTitle: "مشاركة رابط الصورة",
                shareDesc: "ارفع صورة للحصول على رابط مباشر للمشاركة. لا يوجد حد للحجم.",
                shareDrop: "اضغط أو اسحب الصورة هنا",
                uploading: "جاري الرفع...",
                close: "إغلاق"
            },
            en: {
                pageTitle: "Professional AI Background Remover",
                appTitle: "AI Background Remover",
                modelBadge: "IS-Net Ultra HD",
                features: "High Res (5500x5500) • Auto Remove",
                heroTitleStart: "Remove Backgrounds",
                heroTitleHighlight: "Smart & Precise",
                heroSubtitle: "Upload your photos and AI will automatically remove the background and resize to 5500x5500 pixels.",
                autoDownload: "Auto download after processing",
                upscaleOption: "Upscale Image (5500x5500)",
                enhanceOption: "Enhance Quality (AI)",
                removeBgOption: "Remove Background",
                dropText: "Click here or drag & drop images",
                supportedFormats: "Supports JPG, PNG, WEBP (Multiple files)",
                processing: "Processing...",
                downloadAll: "Download All (ZIP)",
                clearAll: "Clear All",
                copyright: "© 2026 AI Background Remover. All rights reserved.",
                download: "Download",
                shareLink: "Share Image",
                shareTitle: "Share Image Link",
                shareDesc: "Upload an image to get a direct share link. No size limit.",
                shareDrop: "Click or drag image here",
                uploading: "Uploading...",
                close: "Close"
            }
        };

        // --- State Management ---
        let currentLang = localStorage.getItem('lang') || 'ar';
        let isDark = localStorage.getItem('theme') === 'dark';

        // --- Initialization ---
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
        updateText();

        if (isDark) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // --- Toggle Functions ---
        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('lang', currentLang);
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            updateText();
        }

        function updateText() {
            document.getElementById('lang-text').textContent = currentLang === 'ar' ? 'EN' : 'عربي';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            // Update dynamic elements like buttons already on screen
            document.querySelectorAll('.download-btn .btn-text').forEach(el => {
                el.textContent = translations[currentLang].download;
            });
        }

        function toggleTheme() {
            isDark = !isDark;
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }


        // --- App Logic ---
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultsGrid = document.getElementById('results-grid');
        const progressSection = document.getElementById('progress-section');
        const actionsSection = document.getElementById('actions-section');
        const progressBar = document.getElementById('progress-bar');
        const completedCountSpan = document.getElementById('completed-count');
        const totalCountSpan = document.getElementById('total-count');
        const autoDownloadCheckbox = document.getElementById('auto-download');
        const upscaleCheckbox = document.getElementById('upscale-check');
        const enhanceCheckbox = document.getElementById('enhance-check');
        const removeBgCheckbox = document.getElementById('remove-bg-check');
        const template = document.getElementById('result-item-template');

        let processedFiles = []; // {name, blob, id}
        let activeProcessingCount = 0;
        let fileIdCounter = 0;

        // Drag & Drop Handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (!files.length) return;
            const fileArray = Array.from(files);
            progressSection.classList.remove('hidden');
            actionsSection.classList.add('hidden'); 
            totalCountSpan.textContent = parseInt(totalCountSpan.textContent) + fileArray.length;
            fileArray.forEach(file => processImage(file));
        }

        async function processImage(file) {
            activeProcessingCount++;
            fileIdCounter++;
            const currentId = fileIdCounter;

            // Create UI Element
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('div');
            // Attach fileObj to DOM element for Alt Text function
            card.classList.add('result-card');
            
            const img = clone.querySelector('.processed-img');
            const originalImg = clone.querySelector('img[alt="Original"]');
            const statusOverlay = clone.querySelector('.status-overlay');
            const nameEl = clone.querySelector('.file-name');
            const nameInput = clone.querySelector('.name-input');
            const editBtn = clone.querySelector('.edit-btn');
            const sizeEl = clone.querySelector('.file-size');
            const downloadBtn = clone.querySelector('.download-btn');
            const btnText = clone.querySelector('.btn-text');

            // --- Alt Text Setup ---
            const btnAlt = clone.querySelector('.btn-alt');
            const altText = clone.querySelector('.alt-text');
            const altStatus = clone.querySelector('.alt-status');
            
            btnAlt.id = `btn-alt-${currentId}`;
            altText.id = `alt-${currentId}`;
            altStatus.id = `status-${currentId}`;
            
            btnAlt.onclick = () => {
                if (card.fileObj && card.fileObj.blob) {
                    generateAltText(card.fileObj.blob, currentId);
                } else {
                    alert(currentLang === 'ar' ? 'يرجى الانتظار حتى اكتمال المعالجة' : 'Please wait for processing to complete');
                }
            };

            nameEl.textContent = file.name;
            nameEl.title = file.name;
            sizeEl.textContent = formatBytes(file.size);
            btnText.textContent = translations[currentLang].download;
            
            // Preview
            const objectUrl = URL.createObjectURL(file);
            img.src = objectUrl; 
            img.classList.add('opacity-50', 'blur-sm'); 
            originalImg.src = objectUrl; 
            
            statusOverlay.classList.remove('hidden');
            downloadBtn.disabled = true;

            resultsGrid.prepend(card); 

            // Upload & Process
            const formData = new FormData();
            
            // Client-side Resize/Compression before Upload
            let fileToUpload = file;
            
            // Check for unsupported formats (HEIC, TIFF, BMP) or Large Size
            // Convert everything to JPEG if problematic
            const needsConversion = file.size > 2 * 1024 * 1024 || 
                                  !['image/jpeg', 'image/png', 'image/webp'].includes(file.type);

            if (needsConversion) { 
                try {
                    fileToUpload = await compressImage(file);
                } catch (e) {
                    console.warn("Compression/Conversion failed, trying original", e);
                    // If compression fails and it's not a supported web format, it might fail on server
                }
            }

            formData.append('file', fileToUpload);
            formData.append('upscale', upscaleCheckbox.checked);
            formData.append('enhance', enhanceCheckbox.checked);
            formData.append('remove_bg', removeBgCheckbox.checked);

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to process');

                const blob = await response.blob();
                const processedUrl = URL.createObjectURL(blob);
                const processedName = `processed_${file.name.replace(/\.[^/.]+$/, "")}.png`;

                // Update UI
                img.src = processedUrl;
                img.classList.remove('opacity-50', 'blur-sm');
                statusOverlay.classList.add('hidden');
                downloadBtn.disabled = false;
                sizeEl.textContent = formatBytes(blob.size); 
                nameEl.textContent = processedName;

                // Store
                const fileObj = { id: currentId, name: processedName, blob: blob };
                processedFiles.push(fileObj);
                
                // Link DOM element to file object
                card.fileObj = fileObj;

                // Renaming Logic
                const enableEdit = () => {
                    nameEl.classList.add('hidden');
                    nameInput.classList.remove('hidden');
                    nameInput.value = fileObj.name;
                    nameInput.focus();
                };
                
                const saveEdit = () => {
                    const newName = nameInput.value.trim();
                    if (newName && newName.length > 0) {
                        // Ensure extension
                        const finalName = newName.toLowerCase().endsWith('.png') ? newName : newName + '.png';
                        
                        fileObj.name = finalName;
                        nameEl.textContent = finalName;
                        nameEl.title = finalName;
                        
                        // Update download click
                        downloadBtn.onclick = () => {
                            if (upscaleCheckbox.checked) {
                                upscaleAndDownload(fileObj.blob, fileObj.name);
                            } else {
                                saveAs(fileObj.blob, fileObj.name);
                            }
                        };
                    }
                    nameInput.classList.add('hidden');
                    nameEl.classList.remove('hidden');
                };

                editBtn.onclick = enableEdit;
                nameEl.onclick = enableEdit; // Also click on name to edit
                
                nameInput.addEventListener('blur', saveEdit);
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        nameInput.blur();
                    }
                });

                // Setup Download Button (Initial)
                downloadBtn.onclick = () => {
                    if (upscaleCheckbox.checked) {
                        upscaleAndDownload(fileObj.blob, fileObj.name);
                    } else {
                        saveAs(fileObj.blob, fileObj.name);
                    }
                };

                // Auto Download
                if (autoDownloadCheckbox.checked) {
                    if (upscaleCheckbox.checked) {
                        upscaleAndDownload(fileObj.blob, fileObj.name);
                    } else {
                        saveAs(blob, processedName);
                    }
                }

                updateProgress();

            } catch (error) {
                console.error(error);
                let errorMsg = currentLang === 'ar' ? 'فشل المعالجة' : 'Processing Failed';
                
                // Better Error Handling
                if (file.size > 4.5 * 1024 * 1024) {
                    errorMsg = currentLang === 'ar' ? 'حجم الملف كبير جداً (>4.5MB)' : 'File too large (>4.5MB)';
                } else if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                    errorMsg = currentLang === 'ar' ? 'صيغة غير مدعومة' : 'Unsupported Format';
                }

                statusOverlay.innerHTML = `
                    <div class="text-center text-red-500">
                        <i class="fa-solid fa-circle-exclamation text-3xl mb-2"></i>
                        <p>${errorMsg}</p>
                    </div>
                `;
                updateProgress(true); 
            }
        }

        let completedTasks = 0;
        
        async function upscaleAndDownload(blob, filename) {
            try {
                const imgBitmap = await createImageBitmap(blob);
                const canvas = document.createElement('canvas');
                canvas.width = 5500;
                canvas.height = 5500;
                const ctx = canvas.getContext('2d');
                
                const scale = Math.min(canvas.width / imgBitmap.width, canvas.height / imgBitmap.height);
                const x = (canvas.width / 2) - (imgBitmap.width / 2) * scale;
                const y = (canvas.height / 2) - (imgBitmap.height / 2) * scale;
                
                ctx.drawImage(imgBitmap, x, y, imgBitmap.width * scale, imgBitmap.height * scale);
                
                canvas.toBlob((upscaledBlob) => {
                    if (upscaledBlob) {
                        saveAs(upscaledBlob, filename);
                    } else {
                        throw new Error("Canvas to Blob failed");
                    }
                }, 'image/png');
            } catch (err) {
                console.error("Upscale failed", err);
                alert(currentLang === 'ar' ? 'فشل تكبير الصورة (قد تكون الذاكرة غير كافية). سيتم تحميل الصورة بالحجم الأصلي.' : 'Upscale failed (Memory limit). Downloading original size.');
                saveAs(blob, filename);
            }
        }

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Max dimension 2048px (Safe for Vercel Free Tier)
                    const MAX_DIM = 2048;
                    if (width > MAX_DIM || height > MAX_DIM) {
                        if (width > height) {
                            height *= MAX_DIM / width;
                            width = MAX_DIM;
                        } else {
                            width *= MAX_DIM / height;
                            height = MAX_DIM;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            // Re-create file object with original name
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg', // Force JPEG for better compression before upload
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        } else {
                            reject(new Error('Canvas to Blob failed'));
                        }
                    }, 'image/jpeg', 0.9); // 90% Quality
                };
                img.onerror = reject;
            });
        }

        function updateProgress(isError = false) {
            completedTasks++;
            const total = parseInt(totalCountSpan.textContent);
            completedCountSpan.textContent = completedTasks;
            progressBar.style.width = `${(completedTasks / total) * 100}%`;

            if (completedTasks === total) {
                setTimeout(() => {
                    actionsSection.classList.remove('hidden');
                    progressSection.classList.add('hidden'); 
                }, 500);
            }
        }

        async function downloadAllAsZip() {
            if (processedFiles.length === 0) return;
            const zip = new JSZip();
            // Use current names from processedFiles array (which are updated by renaming)
            processedFiles.forEach(f => zip.file(f.name, f.blob));
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "processed_images.zip");
        }

        function clearAll() {
            resultsGrid.innerHTML = '';
            processedFiles = [];
            completedTasks = 0;
            totalCountSpan.textContent = '0';
            completedCountSpan.textContent = '0';
            progressBar.style.width = '0%';
            actionsSection.classList.add('hidden');
            fileInput.value = '';
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // --- Share Modal Logic ---
        function toggleShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.toggle('hidden');
        }

        const shareDropZone = document.getElementById('share-drop-zone');
        const shareFileInput = document.getElementById('share-file-input');

        shareDropZone.addEventListener('click', () => shareFileInput.click());
        shareFileInput.addEventListener('change', (e) => handleShareFile(e.target.files[0]));

        shareDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            shareDropZone.classList.add('border-blue-500');
        });

        shareDropZone.addEventListener('dragleave', () => {
            shareDropZone.classList.remove('border-blue-500');
        });

        shareDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            shareDropZone.classList.remove('border-blue-500');
            if (e.dataTransfer.files.length) {
                handleShareFile(e.dataTransfer.files[0]);
            }
        });

        async function handleShareFile(file) {
            if (!file) return;
            
            document.getElementById('share-progress').classList.remove('hidden');
            document.getElementById('share-result').classList.add('hidden');
            const progressBar = document.getElementById('share-progress-bar');
            progressBar.style.width = '0%';
            
            try {
                // 1. Get Server (New API: servers instead of getServer)
                const serverRes = await fetch('https://api.gofile.io/servers');
                const serverData = await serverRes.json();
                
                if (serverData.status !== 'ok') throw new Error('Could not get upload server');
                
                // Select a server (prefer 'eu' zone or just take first)
                const serverObj = serverData.data.servers[0];
                const server = serverObj.name;
                
                // 2. Upload (New Endpoint: contents/uploadfile)
                const formData = new FormData();
                formData.append('file', file);
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://${server}.gofile.io/contents/uploadfile`, true);
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = `${percent}%`;
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.status === 201) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.status === 'ok') {
                                const link = response.data.downloadPage;
                                document.getElementById('share-link-input').value = link;
                                document.getElementById('share-result').classList.remove('hidden');
                                document.getElementById('share-progress').classList.add('hidden');
                            } else {
                                alert('Upload failed: ' + (response.status || 'Unknown error'));
                                document.getElementById('share-progress').classList.add('hidden');
                            }
                        } catch (e) {
                             console.error("JSON Parse Error", e);
                             alert('Upload failed: Invalid server response');
                             document.getElementById('share-progress').classList.add('hidden');
                        }
                    } else {
                        alert('Upload failed: ' + xhr.status);
                        document.getElementById('share-progress').classList.add('hidden');
                    }
                };
                
                xhr.onerror = () => {
                    alert('Upload error (Network/CORS)');
                    document.getElementById('share-progress').classList.add('hidden');
                };
                
                xhr.send(formData);
                
            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
                document.getElementById('share-progress').classList.add('hidden');
            }
        }

        function copyShareLink() {
            const input = document.getElementById('share-link-input');
            input.select();
            document.execCommand('copy'); 
            navigator.clipboard.writeText(input.value);
            alert(currentLang === 'ar' ? 'تم نسخ الرابط!' : 'Link copied!');
        }
    </script>
</body>
</html>
